<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Career Assistant</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
:root {
    --bg-dark:#020617;
    --bg-main:#0f172a;
    --bg-card:#1e293b;
    --primary:#4f46e5;
    --text:#f1f5f9;
    --muted:#94a3b8;
    --border:#334155;
}

* { box-sizing:border-box; }

body {
    margin:0;
    font-family:Inter,sans-serif;
    background:var(--bg-main);
    color:var(--text);
    height:100vh;
    display:flex;
    overflow:hidden;
}

/* ================= SIDEBAR ================= */
#sidebar {
    width:280px;
    background:var(--bg-dark);
    border-right:1px solid var(--border);
    padding:16px;
    display:flex;
    flex-direction:column;
    transition:transform 0.3s ease;
    position:relative;
    z-index:100;
}

#sidebar.hidden {
    transform:translateX(-100%);
}

.sidebar-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:15px;
}

.sidebar-header h3 { 
    margin:0;
    font-size:18px;
}

.history-list {
    flex:1;
    overflow-y:auto;
    margin-top:10px;
}

.history-list::-webkit-scrollbar {
    width:6px;
}

.history-list::-webkit-scrollbar-thumb {
    background:var(--border);
    border-radius:3px;
}

.history-item {
    background:rgba(255,255,255,0.03);
    padding:12px;
    border-radius:10px;
    margin-bottom:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    transition:background 0.2s;
}

.history-item:hover {
    background:rgba(255,255,255,0.08);
}

.chat-left {
    cursor:pointer;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:150px;
    font-size:14px;
}

.chat-actions {
    display:flex;
    gap:6px;
}

.chat-actions button {
    background:none;
    border:none;
    color:var(--muted);
    cursor:pointer;
    font-size:14px;
    transition:all 0.2s;
}

.chat-actions button:hover {
    color:white;
    transform:scale(1.1);
}

.new-chat-btn {
    background:var(--primary);
    border:none;
    padding:12px;
    border-radius:10px;
    color:white;
    cursor:pointer;
    font-weight:500;
    transition:transform 0.2s;
}

.new-chat-btn:hover {
    transform:translateY(-1px);
}

/* ================= MAIN ================= */
.main {
    flex:1;
    display:flex;
    flex-direction:column;
    position:relative;
    min-width:0;
}

/* Header */
.header {
    background:var(--bg-dark);
    padding:14px 20px;
    display:flex;
    align-items:center;
    border-bottom:1px solid var(--border);
    position:sticky;
    top:0;
    z-index:10;
}

.toggle-btn {
    font-size:22px;
    cursor:pointer;
    margin-right:15px;
    transition:transform 0.2s;
}

.toggle-btn:hover {
    transform:scale(1.1);
}

.header h3 {
    margin:0;
    font-size:18px;
    flex:1;
}

/* Profile */
.profile-wrapper {
    margin-left:auto;
    position:relative;
    cursor:pointer;
}

.profile-avatar {
    width:38px;
    height:38px;
    border-radius:50%;
    background:var(--primary);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:600;
    transition:transform 0.2s;
}

.profile-avatar:hover {
    transform:scale(1.05);
}

.profile-dropdown {
    position:absolute;
    right:0;
    top:50px;
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:10px;
    padding:12px;
    display:none;
    min-width:200px;
    box-shadow:0 4px 20px rgba(0,0,0,0.3);
}

.profile-dropdown div:first-child {
    font-weight:600;
    margin-bottom:4px;
}

.profile-dropdown div:last-child {
    font-size:13px;
    color:var(--muted);
}

/* Chat Window */
#chat-window {
    flex:1;
    overflow-y:auto;
    padding:20px;
    padding-bottom:160px;
    display:flex;
    flex-direction:column;
}

#chat-window::-webkit-scrollbar {
    width:8px;
}

#chat-window::-webkit-scrollbar-thumb {
    background:var(--border);
    border-radius:3px;
}

/* WhatsApp-style messages */
.msg {
    display:inline-block;
    max-width:70%;
    padding:12px 16px;
    border-radius:12px;
    margin-bottom:12px;
    word-wrap:break-word;
    line-height:1.5;
    font-size:15px;
    animation:fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity:0;
        transform:translateY(10px);
    }
    to {
        opacity:1;
        transform:translateY(0);
    }
}

.msg.user {
    background:var(--primary);
    align-self:flex-end;
    margin-left:auto;
    border-bottom-right-radius:4px;
}

.msg.bot {
    background:var(--bg-card);
    border:1px solid var(--border);
    align-self:flex-start;
    border-bottom-left-radius:4px;
}

.msg.bot p {
    margin:0 0 10px 0;
}

.msg.bot p:last-child {
    margin-bottom:0;
}

.msg.bot ul, .msg.bot ol {
    margin:8px 0;
    padding-left:20px;
}

.msg.bot li {
    margin:4px 0;
}

.msg.bot code {
    background:rgba(0,0,0,0.3);
    padding:2px 6px;
    border-radius:4px;
    font-size:13px;
}

.msg.bot pre {
    background:rgba(0,0,0,0.3);
    padding:12px;
    border-radius:6px;
    overflow-x:auto;
    margin:8px 0;
}

.msg.bot pre code {
    background:none;
    padding:0;
}

/* Typing */
#typing {
    display:none;
    color:var(--primary);
    margin-left:20px;
    font-size:14px;
    animation:pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity:0.5; }
    50% { opacity:1; }
}

/* Input */
.input-bar {
    position:absolute;
    bottom:0;
    width:100%;
    padding:20px;
    background:linear-gradient(transparent,var(--bg-main) 40%);
    pointer-events:none;
}

.input-box {
    max-width:850px;
    margin:auto;
    display:flex;
    align-items:center;
    gap:10px;
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:25px;
    padding:8px 12px;
    pointer-events:all;
    transition:border-color 0.2s;
}

.input-box:focus-within {
    border-color:var(--primary);
}

.input-box input {
    flex:1;
    background:none;
    border:none;
    color:white;
    outline:none;
    font-size:15px;
    padding:8px;
}

.input-box input::placeholder {
    color:var(--muted);
}

.input-box label {
    cursor:pointer;
    font-size:20px;
    color:var(--muted);
    transition:color 0.2s;
    display:flex;
    align-items:center;
}

.input-box label:hover {
    color:white;
}

.input-box button {
    background:var(--primary);
    border:none;
    color:white;
    border-radius:50%;
    width:38px;
    height:38px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:transform 0.2s;
    font-size:18px;
}

.input-box button:hover {
    transform:scale(1.05);
}

.input-box button:active {
    transform:scale(0.95);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    #sidebar {
        position:absolute;
        height:100%;
        z-index:1000;
    }

    #sidebar.hidden {
        transform:translateX(-100%);
    }

    .msg {
        max-width:85%;
        font-size:14px;
    }

    .header h3 {
        font-size:16px;
    }

    .input-box {
        margin:0 10px;
    }
}

@media (max-width: 480px) {
    .msg {
        max-width:90%;
    }

    #sidebar {
        width:260px;
    }
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div id="sidebar">
    <div class="sidebar-header">
        <h3>Chats</h3>
    </div>

    <button class="new-chat-btn" onclick="newChat()">+ New Chat</button>

    <div class="history-list"></div>
</div>

<!-- MAIN -->
<div class="main">

    <div class="header">
        <span class="toggle-btn" onclick="toggleSidebar()">‚ò∞</span>
        <h3>AI Career Assistant</h3>

        <div class="profile-wrapper" onclick="toggleProfile()">
            <div class="profile-avatar">
                {{ user.username|first|upper }}
            </div>
            <div class="profile-dropdown" id="profileDropdown">
                <div>{{ user.get_full_name|default:user.username }}</div>
                <div>{{ user.email }}</div>
            </div>
        </div>
    </div>

    <div id="chat-window">
        <div class="msg bot">
            Hi {{ user_display_name }}, how can I help you today?
        </div>
    </div>

    <div id="typing">Assistant is thinking...</div>

    <div class="input-bar">
        <div class="input-box">
            <label for="file-upload">‚ûï</label>
            <input type="file" id="file-upload" multiple hidden onchange="uploadFiles()">

            <input id="input" placeholder="Ask something..." onkeydown="if(event.key==='Enter')send()">
            <button onclick="send()">‚û§</button>
        </div>
    </div>
</div>

<script>
let currentSession = null;

/* Sidebar toggle */
function toggleSidebar(){
    document.getElementById('sidebar').classList.toggle('hidden');
}

/* Profile dropdown */
function toggleProfile(){
    const d=document.getElementById('profileDropdown');
    d.style.display=d.style.display==='block'?'none':'block';
}
document.addEventListener('click',e=>{
    if(!e.target.closest('.profile-wrapper')){
        const d=document.getElementById('profileDropdown');
        if(d) d.style.display='none';
    }
});

/* Messages */
function addMsg(text, type) {
    const chatWindow = document.getElementById('chat-window');
    const div = document.createElement('div');
    div.className = `msg ${type}`;

    if (type === 'bot') {
        div.innerHTML = marked.parse(text || '');
    } else {
        div.textContent = text;
    }

    chatWindow.appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });
}

/* Upload files */
async function uploadFiles(){
    const input=document.getElementById('file-upload');
    if(!input.files.length) return;

    const form=new FormData();
    for(const f of input.files) form.append('files',f);

    const res=await fetch('/api/upload/',{
        method:'POST',
        headers:{'X-CSRFToken':'{{ csrf_token }}'},
        body:form
    });

    const data=await res.json();
    addMsg(data.message,'bot');
    input.value='';
}

/* Send message */
async function send() {
    const input = document.getElementById('input');
    const text = input.value.trim();
    if (!text) return;

    addMsg(text, 'user');
    input.value = '';

    try {
        const res = await fetch('/chatbot/api/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                question: text,
                session_id: currentSession
            })
        });

        const data = await res.json();

        if (data.answer) {
            addMsg(data.answer, 'bot');
            currentSession = data.session_id;
        } else {
            addMsg('No response from AI.', 'bot');
        }

    } catch (err) {
        addMsg('Error connecting to server.', 'bot');
    }
}

/* Load history */
async function loadHistory(){
    const res=await fetch('/api/history/');
    const chats=await res.json();
    const list=document.querySelector('.history-list');
    list.innerHTML='';

    chats.forEach(c=>{
        const div=document.createElement('div');
        div.className='history-item';
        div.innerHTML=`
            <div class="chat-left" onclick="loadSession(${c.id})">${c.title}</div>
            <div class="chat-actions">
                <button onclick="renameChat(${c.id})">‚úèÔ∏è</button>
                <button onclick="deleteChat(${c.id})">üóëÔ∏è</button>
            </div>
        `;
        list.appendChild(div);
    });
}

/* Load session */
function loadSession(id){
    fetch(`/api/history/${id}/`).then(r=>r.json()).then(d=>{
        currentSession=id;
        const w=document.getElementById('chat-window');
        w.innerHTML='';
        d.messages.forEach(m=>addMsg(m.content,m.sender));
    });
}

/* Rename */
async function renameChat(id){
    const t=prompt("New chat name");
    if(!t) return;

    await fetch(`/api/chat/${id}/rename/`,{
        method:'POST',
        headers:{
            'Content-Type':'application/json',
            'X-CSRFToken':'{{ csrf_token }}'
        },
        body:JSON.stringify({title:t})
    });
    loadHistory();
}

/* Delete */
async function deleteChat(id){
    if(!confirm("Delete this chat?")) return;

    await fetch(`/api/chat/${id}/delete/`,{
        method:'POST',
        headers:{'X-CSRFToken':'{{ csrf_token }}'}
    });

    if(currentSession===id){
        document.getElementById('chat-window').innerHTML='';
        currentSession=null;
    }
    loadHistory();
}

/* New chat */
function newChat(){
    currentSession=null;
    document.getElementById('chat-window').innerHTML='';
}

/* Init */
document.addEventListener('DOMContentLoaded',loadHistory);
window.addEventListener('load', () => {
    document.querySelectorAll('.msg.bot').forEach(div => {
        div.innerHTML = marked.parse(div.innerText);
    });
});
</script>

</body>
</html>